#!/bin/sh

log_debug() {
	echo "Debug: piuparts exception for package $PIUPARTS_OBJECTS"
}

echo "Debug: running script $0"

#
# deal with packages depending on exceptions:
#
case $PIUPARTS_OBJECTS in
	ltsp-client)		log_debug
				PIUPARTS_OBJECTS=ltsp-client-core
				;;
	netscript-2.4-upstart)	log_debug
				PIUPARTS_OBJECTS=upstart
				;;
	live-config-upstart)	log_debug
				PIUPARTS_OBJECTS=upstart
				;;
	clvm|dtc-xen|ganeti2|mylvmbackup)
				log_debug
				PIUPARTS_OBJECTS=lvm2
				;;
esac

#
# deal with exceptions:
#
case $PIUPARTS_OBJECTS in 
	fai-nfsroot)		log_debug
				# fai-nfsroot refuses installation unless this file exist
				touch /.THIS_IS_THE_FAI_NFSROOT
				;;
	ltsp-client-core)	log_debug
				# ltsp-client-core refuses installation unless this file exist
				touch /etc/ltsp_chroot
				;;
	upstart)		log_debug
				# force installation and removal of essential package sysvinit
				yes 'Yes, do as I say!' | apt-get -y --force-yes install upstart
				;;
	file-rc)		log_debug
				# force installation and removal of essential package sysv-rc
				yes 'Yes, do as I say!' | apt-get -y --force-yes install file-rc
				;;
	systemd-sysv)		log_debug
				# force installation and removal of essential package sysvinit
				yes 'Yes, do as I say!' | apt-get -y --force-yes install systemd-sysv
				;;
	lvm2)
				if [ "$PIUPARTS_PHASE" = "install" ] && [ "$PIUPARTS_DISTRIBUTION" = "squeeze" ]; then
					# work around lvm2 bug http://bugs.debian.org/603036 which is squeeze-ignore
					log_debug
					apt-get -y install udev
				fi
				;;
esac

exit 0

