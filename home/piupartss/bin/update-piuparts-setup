#!/bin/sh -x

#
#  update piuparts setup on piatti.debian.org
#
#   (c) 2009 Holger Levsen         holger@layer-acht.org
#   GPL2 licenced
#

if [ "`id -n -u`" != "piupartss" ] ; then
        echo please run this script as piupartss user
        exit 1
fi

set -e

#
# update slave home, mostly scripts
#
cd ~
pwd
svn up
svn status

#
# update master home, that's mostly crontab to run piuparts-reports
#
# this is done as piupartsm user, as else ~piupartsm needs to be writeable
# by the group, which prevents ssh logins...
#
sudo su - piupartsm -c "pwd ; svn up ; svn status"
sudo su - piupartsm -c "crontab crontab"

#
# update configuration + htdocs
#
cd /org/piuparts.debian.org/etc
pwd
svn up
svn status
cd ../htdocs
pwd
svn up
svn status

#
# update source
#
cd ../src
pwd
svn up
svn status
sudo make prefix=/org/piuparts.debian.org etcdir=/org/piuparts.debian.org/etc install 
sudo rm ../etc/piuparts/ -Rf

