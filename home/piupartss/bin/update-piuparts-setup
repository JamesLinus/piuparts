#!/bin/sh 

#
#  update piuparts setup on piatti.debian.org
#

# Copyright 2009-2011 Holger Levsen (holger@layer-acht.org)
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
# Public License for more details.
# 
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

if [ "`id -n -u`" != "piupartss" ] ; then
        echo please run this script as piupartss user
        exit 1
fi

set -e

#
# update slave home, mostly scripts
#
cd 
# get rid of svn
if [ -d .svn ] ; then
	rm .svn -rf
fi

if [ ! -d piatti ] ; then
	git clone git://git.debian.org/git/piuparts/piatti.git
        cd piatti
        git checkout piatti
	cd ..
fi

# git checkout branch if $1 is given
if [ ! -z "$1" ] ; then
	git checkout $1
fi

cd piatti
git pull
cd
cp -r piatti/home/piupartss/* .
cp -r piatti/home/piupartss/.forward .
pwd
crontab crontab

#
# update master home, that's mostly crontab to run piuparts-reports
#
# this is done as piupartsm user, as else ~piupartsm needs to be writeable
# by the group, which prevents ssh logins...
#
cd ~piupartsm
# rm .svn
if [ -d .svn ] ; then
	sudo rm .svn -rf
fi

sudo su - piupartsm -c "cp -r ~piupartss/piatti/home/piupartsm/* . ; cp -ax ~piupartss/piatti/home/piupartsm/.forward ."
sudo su - piupartsm -c "crontab crontab"


#
# update /org/piuparts.debian.org
#
# rm .svn
if [ -d /org/piuparts.debian.org/.svn ] ; then
	rm /org/piuparts.debian.org/.svn -rf
fi
if [ ! -d /org/piuparts.debian.org/ ] ; then
        sudo mkdir -p /org/piuparts.debian.org/
	sudo chown piupartss.piuparts /org/piuparts.debian.org/
	sudo chmod 775 /org/piuparts.debian.org/
fi
cd /org/piuparts.debian.org/
pwd
cp -r ~piupartss/piatti/org/piuparts.debian.org/* .
mkdir -p master slave
sudo chown piupartss.piuparts slave
sudo chown piupartsm.piuparts master htdocs
sudo chmod 775 master slave htdocs
cd /org/piuparts.debian.org/etc
# to support multiple host with this setup
HOSTNAME=`hostname`
ln -sf piuparts.conf.$HOSTNAME piuparts.conf

#
# update source
#
# rm .svn
if [ -d /org/piuparts.debian.org/src/.svn ] ; then
	rm /org/piuparts.debian.org/src/ -rf
fi
if [ ! -d /org/piuparts.debian.org/src/ ] ; then
        sudo mkdir -p /org/piuparts.debian.org/src/
	cd /org/piuparts.debian.org/src/
        sudo chown piupartss.piuparts /org/piuparts.debian.org/src
        sudo chmod 755 /org/piuparts.debian.org/src
	git clone git://git.debian.org/git/piuparts/piuparts.git
	cd piuparts
	git checkout piatti
fi
cd  /org/piuparts.debian.org/src/piuparts
pwd
# git checkout branch if $1 is given
if [ ! -z "$1" ] ; then
	git checkout $1
fi

git pull
sudo make prefix=/org/piuparts.debian.org docdir=/org/piuparts.debian.org/htdocs/doc/ install install-doc

#
# create working dir
#
sudo mkdir -p /org/piuparts.debian.org/tmp

