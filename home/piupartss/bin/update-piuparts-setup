#!/bin/sh 

#
#  update piuparts setup on piatti.debian.org
#
#   (c) 2009 Holger Levsen         holger@layer-acht.org
#   GPL2 licenced
#

if [ "`id -n -u`" != "piupartss" ] ; then
        echo please run this script as piupartss user
        exit 1
fi

set -e

#
# update slave home, mostly scripts
#
cd 
if [ ! -d .svn ] ; then
	svn co svn://svn.debian.org/svn/piuparts/piatti/home/piupartss .
fi
pwd
svn up
svn status

#
# update master home, that's mostly crontab to run piuparts-reports
#
# this is done as piupartsm user, as else ~piupartsm needs to be writeable
# by the group, which prevents ssh logins...
#
cd ~piupartsm
if [ ! -d .svn ] ; then
	sudo su - piupartsm -c "cd ; svn co svn://svn.debian.org/svn/piuparts/piatti/home/piupartsm ."
fi
sudo su - piupartsm -c "pwd ; svn up ; svn status"
sudo su - piupartsm -c "crontab crontab"

#
# update /org/piuparts.debian.org
#
if [ ! -d /org/piuparts.debian.org/.svn ] ; then
        sudo mkdir -p /org/piuparts.debian.org/
	cd /org/piuparts.debian.org/
	svn co svn://svn.debian.org/svn/piuparts/piatti/org/piuparts.debian.org/ .
fi
cd /org/piuparts.debian.org/
pwd
svn up
svn status
mkdir -p master slave
chown piupartss.piuparts slave
chown piupartsm.piuparts master
chmod 755 master slave

#
# update source
#
if [ ! -d /org/piuparts.debian.org/src/.svn ] ; then
        sudo mkdir -p /org/piuparts.debian.org/src/
	cd  /org/piuparts.debian.org/src/
	svn co svn://svn.debian.org/svn/piuparts/trunk .
fi
cd  /org/piuparts.debian.org/src/
pwd
svn up
svn status
sudo make prefix=/org/piuparts.debian.org install-py 

