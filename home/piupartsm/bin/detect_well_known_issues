#!/bin/sh

# Copyright 2009 Holger Levsen (holger@layer-acht.org)
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
# Public License for more details.
# 
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

#
# parse config file
#

TEMPFILE=`mktemp`
egrep "(^sections|^master-directory)" /etc/piuparts/piuparts.conf| sed -e "s# =#=#g" -e "s#= #=#g" -e 's#=#="#' -e 's#$#"#' -e "s#sections#SECTIONS#" -e "s#master-directory#MASTER#" > $TEMPFILE
source $TEMPFILE
rm $TEMPFILE
if [ -z $MASTER ] || [ -z $SECTIONS ] ; then
	echo "sections and/or master-directory not set in /etc/piuparts/piuparts.conf, exiting."
	exit 1
fi

#
# detect packages with miss a depends or use non-essential in purge
#

LOGS=`mktemp`
for SECTION in $SECTIONS ; do 
	rgrep "command not found" $MASTER/$SECTION/pass|cut -d " " -f1|sed -e "s#log:#log#"|sort -u 2>/dev/null >> $LOGS
done
if [ -s $LOGS ] ; then 
	echo 
	echo "Packages which passed the piuparts test but have logs with the string"
	echo "'command not found' in them."
	echo 
	echo "From the third paragraph about the meaning of the depends field in"
	echo "http://www.debian.org/doc/debian-policy/ch-relationships.html#s-binarydeps"
	echo
	echo "The Depends field should also be used if the postinst, prerm or postrm scripts"
	echo "require the package to be present in order to run. __Note, however, that the"
	echo "postrm cannot rely on any non-essential packages to be present during the"
	echo "purge phase__."
	echo 
	echo "Please file bugs!"
	echo 
        for SECTION in $SECTIONS ; do 
		COUNT=$(grep "/$SECTION/" $LOGS | cut -d "_" -f1|sort -u|wc -l)
		echo "Affected packages in $SECTION: " $COUNT
        done
	echo
	cat $LOGS | sed -e "s#$MASTER#http://piuparts.debian.org/#g" 
	echo
fi
rm $LOGS

