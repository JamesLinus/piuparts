#!/bin/sh

# Copyright 2009 Holger Levsen (holger@layer-acht.org)
# 
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
# Public License for more details.
# 
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

MASTER=/org/piuparts.debian.org/master
DISTROS="sid squeeze"

FILE=`mktemp`

for distro in $DISTROS ; do 
	rgrep -l "Cannot initiate the connection to" $MASTER/$distro/fail >> $FILE
done


if [ -s $FILE ] ; then 
	echo "Network problems on piatti.debian.org detected!"
	echo "(By grep'ing for 'Cannot initiate the connection to' in failed logs.)"
	echo 
	echo "Please review the following logfiles and most likely remove them." 
        echo
	echo "If it is always the same package failing, it's likely to be an issue in the"
	echo "package."
	echo
	cat $FILE | sed -e "s#/org/piuparts.debian.org/master/#http://piuparts.debian.org/#g"
	echo
	cat $FILE | sed -e "s#/org/piuparts.debian.org/master/#less /org/piuparts.debian.org/master/#"
	echo
	echo "----------------------------------------------------------------------"
	echo
	cat $FILE | sed -e "s#/org/piuparts.debian.org/master/#rm /org/piuparts.debian.org/master/#"
	echo
fi
rm $FILE
