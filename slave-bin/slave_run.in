#!/bin/sh
set -e

# Copyright 2009-2011 Holger Levsen (holger@layer-acht.org)
# Copyright Â© 2013 Andreas Beckmann (anbe@debian.org)
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

#
# Run piuparts-slave in screen to allow interactive control later on.
#

if [ -z "$1" ] ; then
   SLAVENUM=0
else
   SLAVENUM=$1
fi

if ! `echo $SLAVENUM | grep -E -e "^[0-9]{1}$" >/dev/null` ; then
   echo "slave must be identified as a number between 0 and 9"
   exit
fi

get_config_value PYTHONPATH global PYTHONPATH ''
get_config_value SLAVEROOT global slave-directory
get_config_value PIUPARTS_TMPDIR global tmpdir


export PYTHONPATH

SLAVEROOTDIR=/var/lib/piuparts/slave
SLAVEDIR=$SLAVEROOTDIR/$SLAVENUM

if [ ! -d $SLAVEDIR ] ; then
   install -d $SLAVEDIR
   chown piupartss:piuparts $SLAVEDIR
fi

SCREENLOG=$SLAVEROOTDIR/screenlog.$SLAVENUM
MONITORDIR=/var/lib/piuparts/master/monitor-slave

# prepare environment
rm -f $SCREENLOG

cd $SLAVEROOTDIR
(ps fax|grep -v grep| grep piuparts-slave | grep $SLAVEDIR ) && exit 0
rm -f $SCREENLOG || :					# used by ~piupartsm/bin/detect_slave_problems
rm -f $MONITORDIR/*					# used by several scripts to only warn once a day

trap "cat $SCREENLOG | mail -s 'slave abnormaly ended' piupartsm ; rm $SCREENLOG; exit" TERM EXIT

# if screen session does not exist, create it
# remove screen logs to preserve slave_join logic
( ps ax | grep SCREEN | grep piuparts-slave-screen >/dev/null) ||\
    ( cd $SLAVEROOTDIR; screen -d -m -L -S piuparts-slave-screen; sleep 1; rm -f $SLAVEROOTDIR/screenlog.*)

# make sure there is a window for this slave
screen -S piuparts-slave-screen -X screen -L $SLAVENUM

# launch the slave
screen -S piuparts-slave-screen -p $SLAVENUM -X stuff "
su - piupartss -c \"cd $SLAVEDIR; python /usr/share/piuparts/piuparts-slave\"
"

trap - TERM EXIT

echo "piuparts-slave has been started."
